#pragma once

#include "cocos2d.h"
#include "models/GameModel.h"
#include "CardView.h"
#include <functional>
#include <unordered_map>

/**
 * @brief ??????????????????????????????????
 * @note ???MVC????????????????????????????????????
 */
class GameView : public cocos2d::Node
{
public:
    static GameView* create();

    bool init() override;

    /**
     * @brief ???????????????
     */
    void initLayout();

    /**
     * @brief ?????????????????????????
     * @param cardModel ???????????
     * @return ???????????????
     */
    CardView* createCardView(CardModel* cardModel);

    /**
     * @brief ??????????
     * @param cardId ?????????ID
     */
    void removeCardView(int cardId);

    /**
     * @brief ??????????
     * @param cardId ????ID
     * @return ???ID???????????????????nullptr
     */
    CardView* getCardView(int cardId);

    /**
     * @brief ???????????????
     */
    void refreshAllCardViews();

    // ---------------- ?????? ----------------
    std::function<void(int cardId)> onCardClicked;
    std::function<void()> onUndoClicked;

    //-------------------------------------------
    cocos2d::Node* getReserveLayer() const;
    cocos2d::Vec2 getBaseCardPosition() const;
    void removeReserveCardView(int cardId);
    CardView* updateBaseCardView(CardModel* newBaseCard);
    void moveCardViewToBaseLayer(int cardId, std::function<void()> onComplete = nullptr);
    void moveCardViewToReserveLayer(int cardId, std::function<void()> onComplete = nullptr);
    void moveCardViewToPlayfield(int cardId, const cocos2d::Vec2& position, std::function<void()> onComplete = nullptr);

private:
    /**
     * @brief ??????????????????????
     */
    void addCardToLayer(CardView* cardView, CardModel* cardModel);

    // ---------------- ??????? ----------------
    cocos2d::Node* _playfieldLayer = nullptr;  // ???????????
    cocos2d::Node* _baseCardLayer = nullptr;   // ?????????
    cocos2d::Node* _reserveLayer = nullptr;    // ???????????
    std::unordered_map<int, CardView*> _cardViewMap;  // ????ID???????????
};

